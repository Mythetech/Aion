@using System.Reflection
@using System.Text.Json
@using System.Text.Json.Nodes
@using Aion.Components.Theme
@using Aion.Components.Shared
@using Aion.Components.Shared.Dialogs
@using Aion.Components.Shared.JsonTreeView
@implements IDisposable
<MudStack Class="h-100 w-100">
    <MudStack Row="true" Class="w-100 pa-1" AlignItems="AlignItems.Center">
        <MudPaper Elevation="0" Square="true" Width="calc(100% - 3.5rem)" Class="flex-shrink-1 px-1">
            <MudText Typo="Typo.h6">@_queryName</MudText>
        </MudPaper>
        <MudPaper Elevation="0" Square="true" Width="3.5rem">
            <MudTooltip Text="Close">
                <MudIconButton Icon="@AionIcons.Close" Color="Color.Surface" Variant="Variant.Text" OnClick="@PanelClosed"/>
            </MudTooltip>
        </MudPaper>
    </MudStack>
  
    @if (string.IsNullOrWhiteSpace(_openTab))
    {
        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center">
            <MudText>No context</MudText>
        </MudStack>
    }
    
    @if (_openTab.Equals("Info", StringComparison.OrdinalIgnoreCase))
    {
        <MudStack>
            <MudText>Select an active connection to query your data</MudText>
        </MudStack>
    }
    
    @if (_openTab.Equals(JsonView))
    {
        <MudStack AlignItems="AlignItems.Center" Row="true" Spacing="1" Class="px-4">
            <MudText>Column</MudText>
            <MudText Typo="Typo.caption" Class="mud-text-secondary">@_columnName</MudText>
            <MudSpacer />
            <MudToggleGroup Value="_jsonViewerSelection" ValueChanged="((s) => { _jsonViewerSelection = s; StateHasChanged(); })" T="string" Outlined="true" Color="Color.Primary" Delimiters="true" Size="Size.Small">
                <MudToggleItem T="string" Value="@("raw")">
                    <TooltipIcon Text="JSON (Raw)" Icon="@AionIcons.RawJson" />
                </MudToggleItem>
                <MudToggleItem T="string" Value="@("pretty")">
                    <TooltipIcon Text="JSON (Pretty)" Icon="@AionIcons.PrettyJson" />
                </MudToggleItem>
            </MudToggleGroup>
            <AionIconButton Class="mr-4" Tooltip="Expand" OnClick="OpenJsonViewerDialog" Icon="@AionIcons.ExpandContent"  />
        </MudStack>
        <MudStack Class="pa-2 h-100 w-100">
            @if (_jsonViewerSelection.Equals("Raw", StringComparison.OrdinalIgnoreCase))
            {
                <pre>
            <code>
        @_code
        </code>
        </pre>
            }
            else if (_jsonViewerSelection.Equals("pretty"))
            {
                    <JsonTreeView @ref="_tree" Json="@_code.ParseNestedJson()" Dense="true" Hover="true" />
            }
        </MudStack>
    }

</MudStack>
@code {
    [Inject]
    GlobalAppState AppState { get; set; }

    [Inject] protected IDialogService DialogService { get; set; } = default!;

    [Parameter]
    public EventCallback PanelClosed { get; set; } = default!;

    [Parameter]
    public bool IsOpen { get; set; } = false;

    private MudToggleGroup<string> _toggle;

    private JsonTreeView? _tree;

    private string _queryName = "";

    private string _openTab = "";

    private string JsonView => "JsonView";

    private string _code = "";

    private string _columnName = "";

    private string _jsonViewerSelection = "raw";

    public async Task Open(string tab, string? args = default)
    {
        _openTab = tab;

        if (tab.Equals(JsonView))
        {
            _code = JsonSerializer.Serialize(JsonSerializer.Deserialize<dynamic>(args), new JsonSerializerOptions() { WriteIndented = true });
        }
        
        StateHasChanged();
    }

    public async Task OpenJsonDetailView(QueryResponseJsonDetail columnDetail)
    {
        _openTab = JsonView;

        _queryName = columnDetail.QueryName;

        _columnName = columnDetail.Column;
        
        _code = JsonSerializer.Serialize(JsonSerializer.Deserialize<dynamic>(columnDetail.Json), new JsonSerializerOptions() { WriteIndented = true });
        
        if(_tree != null)
            _tree.ReInitialize();
    
        StateHasChanged();
    }

    protected async Task OpenJsonViewerDialog()
    {
        var options = AionDialogs.CreateDefaultOptions(MaxWidth.ExtraExtraLarge);

        var parameters = new DialogParameters
        {
            { "ViewMode", _jsonViewerSelection },
            { "Json", _code }
        };

        await DialogService.ShowAsync<JsonDetailDialog>("Json Viewer", parameters, options);
    }

    public void Dispose()
    {
        _openTab = "";
        _queryName = "";
        _columnName = "";
        _code = "";
    }
}


@inherits LayoutComponentBase
@using Aion.Components.Theme
@using MudBlazor;
@using Aion.Components.AppContextPanel
@using Aion.Components.AppContextPanel.Commands
@using Aion.Components.Connections.Commands
@using Mythetech.Framework.Infrastructure.MessageBus
@using Mythetech.Framework.Infrastructure.Plugins
@using Mythetech.Framework.Infrastructure.Plugins.Components
@using Mythetech.Framework.Infrastructure.Files
@using Mythetech.Framework.Infrastructure.Secrets
@using Mythetech.Framework.Components.Secrets
@using Aion.Components.Querying.Commands
@using Aion.Components.Search
@using Aion.Components.Settings
@using Aion.Components.History
@using Aion.Components.Shared.Snackbar
@using Aion.Components.Shared
@using Aion.Components.Shared.Dialogs
@using Aion.Components.Infrastructure
@using Aion.Components.Shared.Dialogs.Commands
@using Microsoft.FluentUI.AspNetCore.Components
@implements IDisposable

<MudThemeProvider @ref="_theme" @bind-IsDarkMode="@AppState.IsDarkMode" Theme="@Theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />
<GlobalCommandSnackbarProvider />
<DialogCommandProvider />
<JsApiCommandProvider />
<FluentKeyCodeProvider />

<MudLayout>
    <MudAppBar Class="pl-4" Elevation="0">
        <MudStack Row="true" Class="w-100" AlignItems="@AlignItems.Center" Spacing="0" Justify="Justify.SpaceBetween">
            <MudStack Row="true" AlignItems="@AlignItems.Center" Spacing="0">

                <MudText Class="app-header-font mud-text-secondary pr-4" Typo="Typo.h6">Aion</MudText>
                <MudMenu Variant="Variant.Text" Size="Size.Small" Dense="true" ActivationEvent="MouseEvent.MouseOver"
                    Label="File">
                    <MudMenu Label="New">
                        <MudMenuItem Icon="@AionIcons.Connection"
                            OnClick="@(async () => await Bus.PublishAsync(new PromptCreateConnection()))">Connection
                        </MudMenuItem>
                        <MudMenuItem Icon="@AionIcons.Query"
                            OnClick="@(async () => await Bus.PublishAsync(new CreateQuery()))">Query</MudMenuItem>
                    </MudMenu>
                    <MudMenuItem Icon="@AionIcons.Save"
                        OnClick="@(async () => await Bus.PublishAsync(new SaveQuery()))">Save Query</MudMenuItem>
                    <MudMenuItem Icon="@AionIcons.Save"
                        OnClick="@(async () => await Bus.PublishAsync(new SaveAllQueries()))">Save All Queries
                    </MudMenuItem>
                    <MudMenuItem Icon="@AionIcons.SaveAs"
                        OnClick="@(async () => await Bus.PublishAsync(new SaveQueryAs()))">Save Query as File
                    </MudMenuItem>
                    <MudMenu Label="Export">
                        <MudMenuItem Icon="@AionIcons.Json"
                            OnClick="@(async () => await Bus.PublishAsync(new ExportResultsToJson()))">Export Results to
                            Json</MudMenuItem>
                        <MudMenuItem Icon="@AionIcons.Csv"
                            OnClick="@(async () => await Bus.PublishAsync(new ExportResultsToCsv()))">Export Results to
                            Csv</MudMenuItem>
                        <MudMenuItem Icon="@AionIcons.Spreadsheet"
                            OnClick="@(async () => await Bus.PublishAsync(new ExportResultsToExcel()))">Export Results
                            to Excel</MudMenuItem>
                    </MudMenu>
                </MudMenu>
                <MudMenu Variant="Variant.Text" Size="Size.Small" Dense="true" ActivationEvent="MouseEvent.MouseOver"
                    Label="Edit">
                    <MudMenuItem Icon="@AionIcons.Copy"
                        OnClick="@(async () => await Bus.PublishAsync(new CopyQueryToClipboard()))">Copy Query
                    </MudMenuItem>
                    <MudMenuItem Icon="@AionIcons.Edit"
                        OnClick="@(async () => await Bus.PublishAsync(new PromptRenameActiveQuery()))">Rename Query
                    </MudMenuItem>
                    <MudMenuItem Icon="@AionIcons.Format"
                        OnClick="@(async () => await Bus.PublishAsync(new FormatQuery()))">Format</MudMenuItem>
                    <MudDivider />
                    <MudMenuItem Icon="@Icons.Material.Filled.Edit"
                        OnClick="@(async () => await Bus.PublishAsync(new EnableEditModeFromQuery()))">Edit Mode</MudMenuItem>
                </MudMenu>
                <MudMenu Variant="Variant.Text" Size="Size.Small" Dense="true" ActivationEvent="MouseEvent.MouseOver"
                    Label="Tools">
                    <MudMenu Label="History" StartIcon="@AionIcons.History" Dense="true">
                        <MudMenuItem Icon="@AionIcons.History" OnClick="@HandleViewHistory">View History</MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.DeleteSweep" OnClick="@HandleClearHistory">Clear
                        </MudMenuItem>
                    </MudMenu>
                    <MudMenuItem Icon="@Icons.Material.Filled.Key" OnClick="@HandleOpenSecretManager">Secret Manager
                    </MudMenuItem>
                    @if (Settings.PluginState)
                    {
                        <MudDivider />
                        <MudMenu Label="Plugins" StartIcon="@PluginIcons.DefaultPluginIcon" Dense="true" ListClass="pa-1">
                            @foreach (var plugin in Plugins.Plugins)
                            {
                                <MudMenu ActivationEvent="MouseEvent.MouseOver"
                                         AnchorOrigin="Origin.TopRight"
                                         TransformOrigin="Origin.TopLeft"
                                         Dense="true"
                                         Label="@plugin.Manifest?.Name"
                                         StartIcon="@(plugin.Manifest?.Icon ?? PluginIcons.DefaultPluginIcon)"
                                         ListClass="pa-1">
                                    @foreach (var menuType in plugin.MenuComponents)
                                    {
                                        <PluginMenuItemsRenderer MenuType="@menuType" ItemClass="rounded" PluginContext="@PluginContext" />
                                    }
                                    @if (plugin.MenuComponents.Any())
                                    {
                                        <MudDivider />
                                    }
                                    <MudMenuItem Class="rounded" Icon="@Icons.Material.Filled.Info" OnClick="@(() => HandleAboutPlugin(plugin))">About...</MudMenuItem>
                                    <MudMenuItem Class="rounded" Icon="@(plugin.IsEnabled ? Icons.Material.Filled.Block : Icons.Material.Filled.CheckCircle)" OnClick="@(() => HandleTogglePlugin(plugin))">@(plugin.IsEnabled ? "Disable" : "Enable")</MudMenuItem>
                                </MudMenu>
                            }
                            @if (Plugins.Plugins.Any())
                            {
                                <MudDivider />
                            }
                            <MudMenuItem Class="rounded" Icon="@Icons.Material.Filled.Apps" OnClick="HandleViewPlugins">View Plugins</MudMenuItem>
                            <MudMenuItem Class="rounded" Icon="@Icons.Custom.Uncategorized.FolderOpen" OnClick="HandleOpenPluginDirectory" Disabled="@(string.IsNullOrEmpty(Plugins.PluginDirectory))">Open Directory</MudMenuItem>
                            <MudDivider />
                            <MudMenuItem Class="rounded" Icon="@Icons.Material.Filled.FileUpload" OnClick="HandleImportPlugin">Import Plugin...</MudMenuItem>
                            <MudMenuItem Class="rounded" Icon="@Icons.Material.Filled.Link" OnClick="HandleImportPluginFromUrl">Import from URL...</MudMenuItem>
                        </MudMenu>
                    }
                    <MudDivider />
                    <MudMenuItem Icon="@AionIcons.Settings"
                        OnClick="@HandleOpenSettings">Settings
                    </MudMenuItem>
                </MudMenu>
            </MudStack>
            <MudStack Row="true" Style="width:33%;margin-right: 12%;" AlignItems="@AlignItems.Center" Spacing="0">

                <MudAutocomplete T="SearchModel" Placeholder="Search..." @bind-Value="_search" SearchFunc="@SearchAsync"
                    @ref="_searchAutocomplete" Variant="Variant.Outlined" Dense="true" ShowProgressIndicator="true"
                    Margin="Margin.Dense" Clearable="true" Class="rounded-xl aion-search"
                    OnAdornmentClick="@(async () => await HandleSearch(_search))" InputClass="appbar-narrow-height"
                    AdornmentIcon="@AionIcons.Search" AdornmentColor="MudBlazor.Color.Primary">
                    <ItemTemplate>
                        <MudStack Class="pa-1" Row="true" AlignItems="AlignItems.Center"
                            onclick="@(async () => await HandleSearch(context))">
                            <TooltipIcon Size="Size.Small" Text="@(context.Description ?? context.Kind.ToString())"
                                Icon="@context.Icon" />
                            <MudText>
                                @context
                            </MudText>
                        </MudStack>
                    </ItemTemplate>
                </MudAutocomplete>
            </MudStack>
            <MudStack Row="true" AlignItems="@AlignItems.Center" Spacing="0">
                <AionIconButton Icon="@AionIcons.Help" Tooltip="Help"
                    OnClick="@(async () => await Bus.PublishAsync(new ShowHelp()))" />
            </MudStack>
        </MudStack>
    </MudAppBar>
    <MudDrawer @bind-Open="@AppState.SideBarOpen" Variant="DrawerVariant.Mini" Style="overflow: hidden;">
        <ContextPanel IsDarkMode="@AppState.IsDarkMode" DrawerBackgroundColor="@_backgroundColor"
            DrawerToggled="@(() => AppState.ToggleSideBar())"
            DarkModeToggled="@(() => AppState.IsDarkMode = !AppState.IsDarkMode)" />
        <div class="@($"resizer {(!AppState.SideBarOpen ? "d-none" : "")}")"></div>
    </MudDrawer>
    <MudMainContent Class=" pl-2 pr-0" Style="max-height:100dvh;max-width:100vw;overflow:hidden;">
        <MudContainer Class="px-0 mud-width-full" MaxWidth="MaxWidth.ExtraLarge"
            Style="@($"height:94vh;overflow:hidden;")">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    [Inject]
    protected GlobalAppState AppState { get; set; } = default!;

    [Inject]
    protected Microsoft.JSInterop.IJSRuntime JS { get; set; } = default!;

    [Inject] protected ISnackbar Snackbar { get; set; } = default!;

    [Inject] protected IMessageBus Bus { get; set; } = default!;

    [Inject] protected SearchService SearchService { get; set; } = default!;

    [Inject] protected SettingsState Settings { get; set; } = default!;

    [Inject] protected HistoryState HistoryState { get; set; } = default!;

    [Inject] protected MudBlazor.IDialogService DialogService { get; set; } = default!;

    [Inject] protected IPluginAssetLoader AssetLoader { get; set; } = default!;

    [Inject] protected PluginState Plugins { get; set; } = default!;

    [Inject] protected PluginLoader PluginLoader { get; set; } = default!;

    [Inject] protected PluginContext PluginContext { get; set; } = default!;

    [Inject] protected IFileOpenService FileOpenService { get; set; } = default!;

    [Inject] protected IShowFileService ShowFileService { get; set; } = default!;

    private SearchModel _search = new();

    private MudAutocomplete<SearchModel>? _searchAutocomplete;

    protected MudThemeProvider _theme { get; set; } = default!;

    public bool _isDarkMode = false;

    private bool _assetsLoaded = false;

    private string _backgroundColor => (!AppState.IsDarkMode ? $"background-color:{_theme.Theme.PaletteLight.OverlayLight}"
    : $"background-color:{_theme.Theme.PaletteDark.Black}");

    private MudTheme Theme { get; } = new AionTheme();

    protected override void OnInitialized()
    {
        AppState.OnDarkModeChanged += HandleDarkModeChange;
        Settings.SettingsChanged += HandleSettingsChanged;
        Plugins.StateChanged += OnPluginStateChanged;
        
        Plugins.PluginsActive = Settings.PluginState;

    }

    private void HandleSettingsChanged(SettingsState s) => StateHasChanged();

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            AppState.SetThemeProvider(_theme);
        }

        base.OnAfterRender(firstRender);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await AppState.SetSystemColorMode();
        }

        if (firstRender || !_assetsLoaded)
        {
            await LoadAllPluginAssetsAsync();
            _assetsLoaded = true;
            StateHasChanged();
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    protected async void HandleDarkModeChange(bool isDarkMode)
    {
        await BlazorMonaco.Editor.Global.SetTheme(JS, isDarkMode ? "vs-dark" : "vs");
        StateHasChanged();
    }

    public void Dispose()
    {
        AppState.OnDarkModeChanged -= HandleDarkModeChange;
        Settings.SettingsChanged -= HandleSettingsChanged;
        Plugins.StateChanged -= OnPluginStateChanged;
    }

    private async Task HandleViewHistory()
    {
        await Bus.PublishAsync(new OpenHistoryPanel());
    }

    private async Task HandleClearHistory()
    {
        bool? result = await DialogService.ShowMessageBox(
        "Clear History",
        "Are you sure you want to clear all query history?",
        yesText: "Clear", cancelText: "Cancel");

        if (result == true)
        {
            HistoryState.ClearHistory();
            Snackbar.Add("History cleared", Severity.Success);
        }
    }

    private async Task HandleOpenSecretManager()
    {
        var options = AionDialogs.CreateDefaultOptions(MaxWidth.Large);
        await DialogService.ShowAsync<SecretManagerDialog>("Secret Manager", options);
    }

    private async Task HandleOpenSettings()
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            BackgroundClass = "aion-dialog",
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseButton = false
        };
        await DialogService.ShowAsync<Settings.SettingsDialog>("Settings", options);
    }

    protected async Task<IEnumerable<SearchModel>> SearchAsync(string value, CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(value))
            return [];

        List<SearchModel> results = [];

        await foreach (var r in SearchService.SearchAsync(value, token))
        {
            results.Add(r);
        }

        return results;
    }

    private async Task HandleSearch(SearchModel result)
    {
        if (result.SearchAction != null)
            await result.SearchAction.Invoke();

        if (_searchAutocomplete != null)
            await _searchAutocomplete.ClearAsync();
    }

    private void OnPluginStateChanged(object? sender, EventArgs e)
    {
        _assetsLoaded = false;
        InvokeAsync(StateHasChanged);
    }

    private async Task LoadAllPluginAssetsAsync()
    {
        foreach (var plugin in Plugins.EnabledPlugins)
        {
            await AssetLoader.LoadPluginAssetsAsync(plugin);
        }
    }

    private async Task HandleAboutPlugin(PluginInfo plugin)
    {
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true,
            BackgroundClass = "aion-dialog"
        };

        var parameters = new MudBlazor.DialogParameters
        {
            { "Plugin", plugin }
        };

        await DialogService.ShowAsync<AboutPluginDialog>($"About {plugin.Manifest?.Name}", parameters, options);
    }

    private void HandleTogglePlugin(PluginInfo plugin)
    {
        if (plugin.IsEnabled)
        {
            Plugins.DisablePlugin(plugin.Manifest?.Id ?? "");
        }
        else
        {
            Plugins.EnablePlugin(plugin.Manifest?.Id ?? "");
        }
    }

    private async Task HandleViewPlugins()
    {
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseOnEscapeKey = true,
            BackgroundClass = "aion-dialog"
        };

        await DialogService.ShowAsync<PluginManagementDialog>("Plugin Management", options);
    }

    private async Task HandleOpenPluginDirectory()
    {
        if (!string.IsNullOrEmpty(Plugins.PluginDirectory))
        {
            await ShowFileService.ShowFolderAsync(Plugins.PluginDirectory);
        }
    }

    private async Task HandleImportPlugin()
    {
        var files = await FileOpenService.OpenFileAsync(
            title: "Select Plugin DLL",
            filters: [new FileFilter("Plugin DLLs", ["*.dll"])]);

        if (files.Length == 0) return;

        foreach (var dllPath in files)
        {
            var pluginInfo = PluginLoader.LoadPlugin(dllPath);
            if (pluginInfo is not null)
            {
                Plugins.RegisterPlugin(pluginInfo);
            }
        }
    }

    private async Task HandleImportPluginFromUrl()
    {
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseOnEscapeKey = true,
            BackgroundClass = "aion-dialog"
        };

        await DialogService.ShowAsync<DefaultPluginUrlLoadDialog>("Import Plugin from URL", options);
    }

}